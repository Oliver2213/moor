<!DOCTYPE html>
<html>
<head><title>Welcome</title>
    <!-- Showdown markdown library -->
    <script src="https://cdn.jsdelivr.net/npm/showdown@2.0.3/dist/showdown.min.js"></script>

    <script lang="javascript">

        let context = {
            showdown: null,
            player: null,
            token: null,
            ws: null
        };

        // Utility function to build DOM elements from HTML.
        function generateElements(html) {
            const template = document.createElement('template');
            template.innerHTML = html.trim();
            return template.content.children;
        }

        function write_markdown(markdown, destination, style) {
            let html = context.showdown.makeHtml(markdown);
            let elements = generateElements(html);
            while (elements.length > 0) {
                if (style) {
                    elements[0].classList.add(style);
                }
                destination.appendChild(elements[0]);
            }
        }

        // Retrieve and display welcome message.
        async function retrieve_welcome(welcome_panel) {
            let result = await fetch("/welcome");
            if (result.ok) {
                let welcome_text = await result.json();
                // "welcome_text" is a json array of strings, but we want to treat it as one markdown doc,
                // so we'll join them together with a newline.
                let welcome_markdown = welcome_text.join("\n");
                write_markdown(welcome_markdown, welcome_panel);
            } else {
                console.log("Failed to retrieve welcome text!");
            }
        }
        // Output a system message to the narrative panel.
        function output_system_text(text) {
            let narrative = document.getElementById("narrative");
            write_markdown(text, narrative, "system_message");
            narrative.scrollTop = narrative.scrollHeight;
        }

        // Output a typical narrative message to the narrative panel.
        function output_narrative_text(text) {
            let narrative = document.getElementById("narrative");
            write_markdown(text, narrative, "message");
            // scroll to bottom
            narrative.scrollTop = narrative.scrollHeight;
        }

        function output_narrative_gap() {
            let anchor = document.getElementById("anchor");
            let narrative = document.getElementById("narrative");
            let msg = generateElements("<li class='gap'>&nbsp;</li>")[0];
            narrative.insertBefore(msg, anchor);
            // scroll to bottom
            narrative.scrollTop = narrative.scrollHeight;
        }

        // Process an inbound (JSON) event from the websocket connection to the server.
        function handle_narrative_event(e) {
            // Parse event as JSON.
            let event = JSON.parse(e.data);
            if (event["message"]) {
                output_narrative_text(event["message"]);
            } else if (event["system_message"]) {
                output_system_text(event["system_message"]);
            } else {
                console.log("Unknown event type: " + event);
            }
        }

        // Handle the connect phase in response to a user clicking the "Connect" button.
        async function connect(e) {
            e.preventDefault();
            let form = e.target;
            let data = new URLSearchParams();
            data.set("player", form.player.value);
            data.set("password", form.password.value);
            let result = await fetch("/auth/connect", {
                method: "POST",
                body: data
            });
            if (result.ok) {
                console.log("Connected!");
            } else {
                console.log("Failed to connect!");
                alert("Failed to authenticate!")
                return;
            }
            let connect_form = document.getElementById("connect_form");
            let entry_form = document.getElementById("entry");
            connect_form.style.display = "none";
            entry_form.style.display = "";

            let login_result = await result.text();
            login_result = login_result.split(" ");
            let connect_type = login_result[1].toLowerCase();
            let player = login_result[0];
            let paseto_token = result.headers.get("X-Moor-Auth-Token");
            if (!paseto_token) {
                console.log("No token; authorization denied");
                alert("Could not authenticate!");
                return;
            }

            // Now initiate the websocket connection, attaching the header
            // with the token.
            let ws = new WebSocket("ws://localhost:8080/ws/attach/" + connect_type + "/" + paseto_token);
            context.player = player;
            context.token = paseto_token;
            context.ws = ws;
            ws.onmessage = handle_narrative_event
            
            // Show the narrative panel, and hide the welcome panel.
            let welcome_panel = document.getElementById("welcome");
            welcome_panel.style.display = "none";
            let narrative = document.getElementById("narrative");
            narrative.style.display = "inherit";
        }

        async function handle_input(e) {
            e.preventDefault();
            context.ws.send(e.target.command.value);
            e.target.command.value = "";
            // Put a small gap in the narrative output, to make it easier to read.
            output_narrative_gap();
        }


        // Attach event handlers to our elements in the DOM.
        document.addEventListener("DOMContentLoaded", function () {
            context.showdown = new showdown.Converter({emoji: true, simpleLineBreaks: true});

            let connect_form = document.getElementById("connect_form");
            let entry_form = document.getElementById("entry");

            connect_form.addEventListener("submit", connect);
            entry_form.addEventListener("submit", handle_input);

            let welcome_panel = document.getElementById("welcome");
            retrieve_welcome(welcome_panel);
        });


    </script>
    <style>
        body {
            background-color: #7fdbff;
        }

        li {
            list-style-type: none;
        }

        .message {
            color: black;
            background-color: white;
        }
        .system_message {
            color: darkred;
            background-color: white;
        }
        .gap {
            color: white;
            background-color: white;
            height: 10px;
        }
        #narrative {
            padding: 5px;
            font-family: monospace;
            display: none;
            border-radius: 5px;
            border-width: thick;
            border-style: solid;
            border-color: black;
            overflow-y: scroll;
            background-color: white;
            height: calc(100vh - 100px);
            margin-bottom: 10px;
        }
        #narrative p { margin:0 }

        #welcome {
            padding: 10px;
            font-family: arial,sans-serif;
            border-radius: 5px;
            border-width: thick;
            border-style: solid;
            border-color: black;
            background-color: white;
        }
        #welcome p { margin:0 }

        #anchor {
            overflow-anchor: auto;
            height: 1px;
        }

        #command_input {
            font-family: monospace;
            width: calc(100% - 100px);
        }

        #connect_form {
            text-align: center;
        }
    </style>
</head>
<body>
<!-- welcome message, shown until user connects -->
<div id="welcome">
</div>
<form id="connect_form">
    <input type="text" name="player"/>
    <input type="text" name="password"/>
    <button type="submit">Connect</button>
</form>
<!-- output area, where narrative is displayed, new messages are added at bottom, and scroll is locked to bottom -->
<div id="narrative">
</div>
<form id="entry" style="display: none;">
    <input type="text" name="command" id="command_input"/>
    <button type="submit">Send</button>
</form>
</body>
</html>